{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "report",
    "name" : "Report",
    "deprecated" : false,
    "image" : "tb-image;/api/images/tenant/Capturar_(31).PNG",
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 14,
      "sizeY" : 11.5,
      "resources" : [ {
        "url" : "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
      }, {
        "url" : "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      }, {
        "url" : "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
      }, {
        "url" : "https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      } ],
      "templateHtml" : "<div class=\"widget-container\">\n    <div class=\"widget-header\">\n        <h2 class=\"widget-title\">{{widgetTitle}}</h2>\n        <div class=\"date-range\">\n            <input type=\"date\" \n                   [(ngModel)]=\"startDate\" \n                   (ngModelChange)=\"handleStartDateChange($event)\"\n                   [max]=\"endDateFormatted\">\n            <span>até</span>\n            <input type=\"date\" \n                   [(ngModel)]=\"endDate\" \n                   (ngModelChange)=\"handleEndDateChange($event)\"\n                   [min]=\"startDateFormatted\">\n            <button class=\"load-button\" (click)=\"loadData()\" [disabled]=\"isLoading\">\n                <i class=\"material-icons\">refresh</i>\n                Carregar\n            </button>\n        </div>\n        <div class=\"export-buttons\">\n            <button class=\"export-button\" (click)=\"exportToCSV()\" [disabled]=\"!reportDataSorted || reportDataSorted.length === 0\">\n                <i class=\"material-icons\">file_download</i>\n                CSV\n            </button>\n            <button class=\"export-button\" (click)=\"exportToPDF()\" [disabled]=\"!reportDataSorted || reportDataSorted.length === 0\">\n                <i class=\"material-icons\">picture_as_pdf</i>\n                PDF\n            </button>\n        </div>\n    </div>\n\n    <div *ngIf=\"errorMessage\" class=\"error-message\">\n        {{errorMessage}}\n    </div>\n\n    <div class=\"table-container\" style=\"position: relative;\">\n        <div *ngIf=\"isLoading\" class=\"loading-overlay\">\n            <i class=\"material-icons\" style=\"font-size: 48px; color: #5c307d;\">hourglass_empty</i>\n        </div>\n\n        <table>\n            <thead>\n                <tr>\n                    <th (click)=\"sortBy('deviceName')\">\n                        Loja\n                        <span class=\"sort-icon\" *ngIf=\"sortColumn === 'deviceName'\">\n                            {{sortReverse ? '▼' : '▲'}}\n                        </span>\n                    </th>\n                    <th (click)=\"sortBy('deviceId')\">\n                        Identificador\n                        <span class=\"sort-icon\" *ngIf=\"sortColumn === 'deviceId'\">\n                            {{sortReverse ? '▼' : '▲'}}\n                        </span>\n                    </th>\n                    <th (click)=\"sortBy('consumptionKwh')\">\n                        Consumo (kWh)\n                        <span class=\"sort-icon\" *ngIf=\"sortColumn === 'consumptionKwh'\">\n                            {{sortReverse ? '▼' : '▲'}}\n                        </span>\n                    </th>\n                </tr>\n            </thead>\n            <tbody>\n                <tr *ngIf=\"!reportDataSorted || reportDataSorted.length === 0\">\n                    <td colspan=\"3\" class=\"no-data\">\n                        Nenhum dado disponível\n                    </td>\n                </tr>\n                <tr *ngFor=\"let device of reportDataSorted\">\n                    <td>{{device?.deviceName || 'Dispositivo Desconhecido'}}</td>\n                    <td>{{device?.deviceId || '-'}}</td>\n                    <td [ngClass]=\"{'error-cell': device?.error || !device?.isValid}\">\n                        <span *ngIf=\"!device?.isValid\" class=\"invalid-device\">\n                            <i class=\"material-icons\">error_outline</i>\n                            {{device?.error || 'Dispositivo não configurado'}}\n                        </span>\n                        <span *ngIf=\"device?.isValid\">\n                            {{device?.error || device?.consumptionKwh }}\n                        </span>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</div> \n",
      "templateCss" : "#container {\n    overflow-y: auto;\n}\n\n#main.loading {\n    height: 100%;\n    width: 100%;\n    padding: 0;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: absolute;\n}\n\n#Myio{\n    width: 150px;\n    background-color: #3e1a7d;\n    padding: 10px;\n    border-radius: 5px;\n}\n\n#ReportHeader{\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-end;\n    padding: 5px;\n}\n\np{\n    font-size: 13px;\n    margin: 0;\n    font-family: Roboto;\n}\n\n.button{\n    all: unset;\n    cursor: pointer;\n    position: absolute;\n    top: 8px;\n    right: 40px;\n}\n\n.example-form-field{\n    margin: 0;\n}\n.hide-in-csv.button{\n    right: 60px;\n}\n\n.widget-container {\n    font-family: 'Roboto', sans-serif;\n    padding: 20px;\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.widget-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 20px;\n    flex-wrap: wrap;\n    gap: 16px;\n}\n\n.widget-title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #333;\n    margin: 0;\n}\n\n.date-range {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.date-range input[type=\"date\"] {\n    padding: 8px;\n    border: 1px solid #e0e0e0;\n    border-radius: 4px;\n    font-family: 'Roboto', sans-serif;\n    font-size: 14px;\n    color: #333;\n    background-color: white;\n}\n\n.date-range input[type=\"date\"]:focus {\n    outline: none;\n    border-color: #5c307d;\n}\n\n.date-range span {\n    color: #666;\n    font-size: 14px;\n}\n\n.export-buttons {\n    display: flex;\n    gap: 10px;\n}\n\n.export-button {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    background-color: #5c307d;\n    color: white;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    transition: background-color 0.2s;\n}\n\n.export-button:hover {\n    background-color: #4a265f;\n}\n\n.export-button:disabled {\n    background-color: #ccc;\n    cursor: not-allowed;\n}\n\n.table-container {\n    flex: 1;\n    overflow: auto;\n    border: 1px solid #e0e0e0;\n    border-radius: 4px;\n}\n\ntable {\n    width: 100%;\n    border-collapse: collapse;\n    background-color: white;\n}\n\nth {\n    background-color: #5c307d;\n    color: white;\n    padding: 12px;\n    text-align: left;\n    font-weight: 500;\n    cursor: pointer;\n    user-select: none;\n    position: sticky;\n    top: 0;\n    z-index: 1;\n}\n\nth:hover {\n    background-color: #4a265f;\n}\n\ntd {\n    padding: 12px;\n    border-bottom: 1px solid #e0e0e0;\n}\n\ntr:nth-child(even) {\n    background-color: #f5f7fa;\n}\n\ntr:hover {\n    background-color: #f0f2f5;\n}\n\n.loading-overlay {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(255, 255, 255, 0.8);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    z-index: 2;\n}\n\n.error-message {\n    color: #d32f2f;\n    padding: 12px;\n    background-color: #ffebee;\n    border-radius: 4px;\n    margin-bottom: 16px;\n}\n\n.no-data {\n    text-align: center;\n    padding: 32px;\n    color: #666;\n}\n\n.sort-icon {\n    margin-left: 4px;\n    font-size: 12px;\n}\n\n.error-cell {\n    color: #d32f2f;\n    font-style: italic;\n}\n\n.invalid-device {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    color: #d32f2f;\n}\n\n.invalid-device .material-icons {\n    font-size: 16px;\n    color: #d32f2f;\n}\n\n.load-button {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    background-color: #5c307d;\n    color: white;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    transition: background-color 0.2s;\n}\n\n.load-button:hover {\n    background-color: #4a265f;\n}\n\n.load-button:disabled {\n    background-color: #ccc;\n    cursor: not-allowed;\n}\n\n.load-button .material-icons {\n    font-size: 18px;\n}",
      "controllerScript" : "/* jshint esversion: 11 */\n\n// Constants\nconst PURPLE_COLOR = [92, 48, 125];\nconst STRIPE_COLOR = [245, 247, 250];\nconst PAGE_MARGIN = 10;\nconst LINE_HEIGHT = 10;\nconst LOGO_URL = 'https://dashboard.myio-bas.com/api/images/public/TAfpmF6jEKPDi6hXHbnMUT8MWOHv5lKD';\n\n// State management\nconst state = {\n  startDate: null,\n  endDate: null,\n  deviceNameLabelMap: {},\n  loading: false,\n  data: []\n};\n\n// Utility functions\nfunction formatDate(date) {\n  if (!date || isNaN(new Date(date).getTime())) {\n    // Return today's date if invalid\n    const today = new Date();\n    return today.toISOString().split('T')[0];\n  }\n  const d = new Date(date);\n  return d.toISOString().split('T')[0];\n}\n\nfunction getValidDate(date) {\n  if (!date || isNaN(new Date(date).getTime())) {\n    return new Date();\n  }\n  return new Date(date);\n}\n\nfunction toFixed(value) {\n  if (value == null) return value;\n  return Number(value).toFixed(2);\n}\n\nfunction exportToCSV(reportData) {\n  if (!reportData?.length) {\n    alert('Erro: Nenhum dado disponível para exportar.');\n    return;\n  }\n  const rows = [\n    ['Loja', 'Identificador', 'Consumo']\n  ];\n  reportData.forEach(data => {\n    rows.push([\n      data.deviceName || '-',\n      data.slaveId != null ? data.slaveId : (data.deviceId || '-'),\n      data.consumptionKwh != null ? data.consumptionKwh : '0.00',\n    ]);\n  });\n  const csvContent = \"data:text/csv;charset=utf-8,\" + rows.map(e => e.join(\";\")).join(\"\\n\");\n  const link = document.createElement(\"a\");\n  link.setAttribute(\"href\", encodeURI(csvContent));\n  link.setAttribute(\"download\", `relatorio_consumo_${new Date().toISOString().slice(0, 10)}.csv`);\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n}\n\nfunction exportToPDF(reportData, startDate, endDate) {\n  if (!reportData || !Array.isArray(reportData) || reportData.length === 0) {\n    alert('Erro: Nenhum dado disponível para exportar.');\n    return;\n  }\n\n  const doc = new window.jspdf.jsPDF();\n  const pageWidth = doc.internal.pageSize.width;\n  const pageHeight = doc.internal.pageSize.height;\n  const purple = [92, 48, 125];\n  const margin = 10;\n  const lineHeight = 10;\n  const colWidth = (pageWidth - 2 * margin) / 2;\n\n  function addHeader() {\n    doc.setFillColor(...purple);\n    doc.rect(0, 0, pageWidth, 50, 'F');\n\n    const logoHeight = 25;\n    const logoWidth = Math.round(logoHeight * (512 / 194));\n    const logoX = 15;\n    const logoY = 12;\n\n    doc.addImage(\n      LOGO_URL,\n      'PNG',\n      logoX,\n      logoY,\n      logoWidth,\n      logoHeight\n    );\n\n    const textStartX = logoX + logoWidth + 20;\n    const availableWidth = pageWidth - textStartX - 15;\n    const textCenterX = textStartX + availableWidth / 2;\n\n    doc.setFontSize(12);\n    doc.setTextColor(255, 255, 255);\n    doc.text('Sistema Myio | Registro de Consumo Kwh', textCenterX, 15, { align: 'center' });\n    doc.text(`${self.ctx.$scope.subtitle}`, textCenterX, 23, { align: 'center' })\n    doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, textCenterX, 31, { align: 'center' });\n\n    const fromDate = new Date(startDate.setDate(startDate.getDate() + 1)).toLocaleDateString('pt-BR');\n    const toDate = new Date(endDate.setDate(endDate.getDate() - 1)).toLocaleDateString('pt-BR');\n\n    doc.text(`Período de ${fromDate} até ${toDate}`, textCenterX, 39, { align: 'center' });\n  }\n\n  function addTableHeader(startY) {\n    doc.setFillColor(...purple);\n    doc.rect(margin, startY, pageWidth - 2 * margin, lineHeight, 'F');\n\n    const headers = ['Loja', 'Identificador', 'Consumo'];\n    doc.setTextColor(255, 255, 255);\n    doc.setFontSize(10);\n    headers.forEach((header, i) => {\n      doc.text(header, margin + i * colWidth + colWidth / 2, startY + 7, { align: 'center' });\n    });\n  }\n\n  function addTableRow(rowData, startY, isStriped) {\n    if (isStriped) {\n      doc.setFillColor(245, 247, 250);\n      doc.rect(margin, startY, pageWidth - 2 * margin, lineHeight, 'F');\n    }\n\n    rowData.forEach((text, i) => {\n      doc.setTextColor(0, 0, 0);\n      doc.text(String(text), margin + i * colWidth + colWidth / 2, startY + 7, { align: 'center' });\n    });\n  }\n\n  addHeader();\n\n  let startY = 60;\n  addTableHeader(startY);\n  startY += lineHeight;\n\n  reportData.forEach((data, index) => {\n    if (startY > pageHeight - 20) {\n      doc.addPage();\n      startY = 20;\n      addTableHeader(startY);\n      startY += lineHeight;\n    }\n\n    const rowData = [\n      data.name || '-',\n      data.deviceId || '-',\n      data.kWh ? `${toFixed(data.kWh)} kWh` : '-'\n    ];\n\n    addTableRow(rowData, startY, index % 2 === 0);\n    startY += lineHeight;\n  });\n\n  doc.setFontSize(10);\n  doc.setTextColor(0, 0, 0);\n  doc.text(`Página 1 de 1`, pageWidth / 2, pageHeight - 10, { align: 'center' });\n\n  doc.save(`relatorio_consumo_${new Date().toISOString().slice(0, 10)}.pdf`);\n}\n\nfunction formatDateYMD(date) {\n  if (!date) return '';\n  if (typeof date === 'string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(date)) return date;\n  const d = new Date(date);\n  return d.toISOString().slice(0, 10);\n}\n\n// Helper to get ISO string in America/Sao_Paulo with -03:00 offset\nfunction getSaoPauloISOString(dateStr, endOfDay = false) {\n    if (!dateStr) return '';\n    if (endOfDay) {\n        return `${dateStr}T23:59:59.999-03:00`;\n    } else {\n        return `${dateStr}T00:00:00.000-03:00`;\n    }\n}\n\nself.onInit = async function() {\n\n  self.ctx.$scope.loadData = function() {\n    console.log('Load button clicked');\n    console.log('Current scope state:', {\n      startDate: self.ctx.$scope.startDate,\n      endDate: self.ctx.$scope.endDate,\n      reportData: self.ctx.$scope.reportData,\n      isLoading: self.ctx.$scope.isLoading\n    });\n\n    if (!self.ctx.$scope.startDate || !self.ctx.$scope.endDate) {\n      console.error('Invalid date range');\n      self.ctx.$scope.errorMessage = \"Por favor, selecione um período válido.\";\n      self.ctx.detectChanges();\n      return;\n    }\n\n    if (!self.ctx.$scope.reportData || self.ctx.$scope.reportData.length === 0) {\n      console.error('No devices configured');\n      self.ctx.$scope.errorMessage = \"Nenhum dispositivo configurado para buscar dados.\";\n      self.ctx.detectChanges();\n      return;\n    }\n\n    console.log('Starting data fetch...');\n    fetchConsumptionData();\n  };\n\n  console.log('Widget initialization started');\n\n  // Initialize settings with defaults\n  self.ctx.settings = self.ctx.settings || {};\n\n  // Scope Initialization\n  self.ctx.$scope.widgetTitle = self.ctx.settings.widgetTitle || \"Energy Consumption Report\";\n  self.ctx.$scope.apiBaseUrl = self.ctx.settings.apiBaseUrl || 'https://ingestion.myio-bas.com';\n  self.ctx.$scope.consumptionDecimals = Number(self.ctx.settings.consumptionDecimals);\n  if (isNaN(self.ctx.$scope.consumptionDecimals)) {\n    self.ctx.$scope.consumptionDecimals = 2;\n  }\n  self.ctx.$scope.exportFileName = self.ctx.settings.exportFileName || 'energy_consumption_report';\n\n  // Initialize date handling with validation\n  const minTime = self.ctx.timeWindow?.minTime;\n  const maxTime = self.ctx.timeWindow?.maxTime;\n\n  self.ctx.$scope.startDate = formatDateYMD(minTime);\n  self.ctx.$scope.endDate = formatDateYMD(maxTime);\n\n  // Ensure end date is not before start date\n  if (self.ctx.$scope.endDate < self.ctx.$scope.startDate) {\n    self.ctx.$scope.endDate = new Date(self.ctx.$scope.startDate);\n    self.ctx.$scope.endDate.setDate(self.ctx.$scope.endDate.getDate() + 1);\n  }\n\n  self.ctx.$scope.startDateFormatted = self.ctx.$scope.startDate;\n  self.ctx.$scope.endDateFormatted = self.ctx.$scope.endDate;\n\n  // Initialize data structures\n  self.ctx.$scope.isLoading = true;\n  self.ctx.$scope.errorMessage = null;\n  self.ctx.$scope.reportData = [];\n  self.ctx.$scope.reportDataSorted = [];\n\n  // Sorting state\n  self.ctx.$scope.sortColumn = 'deviceName';\n  self.ctx.$scope.sortReverse = false;\n\n  try {\n    console.log('Fetching device attributes...');\n    const attributeService = self.ctx.$scope.$injector.get(self.ctx.servicesMap.get('attributeService'));\n    const datasources = self.ctx.defaultSubscription.datasources;\n\n    console.log('Available datasources:', datasources);\n\n    if (!datasources || datasources.length === 0) {\n      self.ctx.$scope.errorMessage = \"Nenhum dispositivo configurado. Adicione dispositivos à fonte de dados do widget.\";\n      self.ctx.$scope.isLoading = false;\n      self.ctx.detectChanges();\n      return;\n    }\n\n    const attributeFetchPromises = datasources.map(async (ds) => {\n      console.log('Processing device:', ds);\n      const entityLabel = ds.entityName || ds.label || `Dispositivo (ID: ${ds.entityId.substring(0, 5)})`;\n      let deviceReportEntry = {\n        entityId: ds.entityId,\n        entityAliasId: ds.entityAliasId,\n        deviceName: entityLabel,\n        centralId: null,\n        slaveId: null,\n        consumptionKwh: null,\n        error: null,\n        isValid: false\n      };\n\n      try {\n        if (!ds.entityId || !ds.entityType) {\n          throw new Error(\"Contexto do dispositivo (entityId/entityType) ausente na fonte de dados.\");\n        }\n        console.log(`Fetching attributes for device ${entityLabel} (${ds.entityId})`);\n        const deviceAttributes = await attributeService.getEntityAttributes(\n          { id: ds.entityId, entityType: ds.entityType },\n          'SERVER_SCOPE',\n          ['centralId', 'slaveId']\n        ).toPromise();\n\n        console.log(`Attributes for ${entityLabel}:`, deviceAttributes);\n\n        const centralIdAttr = deviceAttributes.find(attr => attr.key === 'centralId');\n        const slaveIdAttr = deviceAttributes.find(attr => attr.key === 'slaveId');\n\n        const centralIdValue = centralIdAttr ? centralIdAttr.value : null;\n        const slaveIdRawValue = slaveIdAttr ? slaveIdAttr.value : null;\n        const slaveIdValue = typeof slaveIdRawValue === 'string' ? parseInt(slaveIdRawValue, 10) : slaveIdRawValue;\n\n        if (!centralIdValue || slaveIdValue === null || typeof slaveIdValue !== 'number' || isNaN(slaveIdValue)) {\n          deviceReportEntry.error = \"Dispositivo não configurado corretamente (centralId/slaveId ausentes)\";\n          deviceReportEntry.isValid = false;\n        } else {\n          deviceReportEntry.centralId = centralIdValue;\n          deviceReportEntry.slaveId = slaveIdValue;\n          deviceReportEntry.isValid = true;\n        }\n      } catch (attrError) {\n        console.error(`Erro ao buscar atributos para ${entityLabel} (ID: ${ds.entityId}):`, attrError);\n        deviceReportEntry.error = \"Erro ao buscar atributos do dispositivo\";\n        deviceReportEntry.isValid = false;\n      }\n      return deviceReportEntry;\n    });\n\n    console.log('Waiting for all attribute fetches to complete...');\n    self.ctx.$scope.reportData = await Promise.all(attributeFetchPromises);\n    console.log('Initial report data:', self.ctx.$scope.reportData);\n\n    // Count invalid devices\n    const invalidDevices = self.ctx.$scope.reportData.filter(d => !d.isValid).length;\n    if (invalidDevices > 0) {\n      self.ctx.$scope.errorMessage = `${invalidDevices} dispositivo(s) não configurado(s) corretamente. Verifique os atributos centralId e slaveId.`;\n    }\n\n    applySortAndDetectChanges();\n\n  } catch (initError) {\n    console.error(\"Erro durante a inicialização do widget de relatório:\", initError);\n    self.ctx.$scope.errorMessage = initError.message || \"Ocorreu um erro inesperado ao inicializar.\";\n    applySortAndDetectChanges();\n  } finally {\n    self.ctx.$scope.isLoading = false;\n    self.ctx.detectChanges();\n  }\n\n  // Add date change handlers\n  self.ctx.$scope.handleStartDateChange = function(newDate) {\n    self.ctx.$scope.startDate = newDate;\n    self.ctx.$scope.startDateFormatted = newDate;\n    // Ensure end date is not before start date\n    if (self.ctx.$scope.endDate < newDate) {\n      self.ctx.$scope.endDate = newDate;\n      self.ctx.$scope.endDateFormatted = newDate;\n    }\n  };\n\n  self.ctx.$scope.handleEndDateChange = function(newDate) {\n    self.ctx.$scope.endDate = newDate;\n    self.ctx.$scope.endDateFormatted = newDate;\n    // Ensure start date is not after end date\n    if (self.ctx.$scope.startDate > newDate) {\n      self.ctx.$scope.startDate = newDate;\n      self.ctx.$scope.startDateFormatted = newDate;\n    }\n  };\n\n  // Add load function\n  self.ctx.$scope.sortBy = function(columnName) {\n    if (self.ctx.$scope.sortColumn === columnName) {\n      self.ctx.$scope.sortReverse = !self.ctx.$scope.sortReverse;\n    } else {\n      self.ctx.$scope.sortColumn = columnName;\n      self.ctx.$scope.sortReverse = false;\n    }\n    applySortAndDetectChanges();\n  };\n\n  // Add exportToCSV and exportToPDF to $scope so they are accessible from the template\n  self.ctx.$scope.exportToCSV = function() {\n    // Use the existing exportToCSV logic\n    exportToCSV(self.ctx.$scope.reportDataSorted || []);\n  };\n  self.ctx.$scope.exportToPDF = function() {\n    // Use the existing exportToPDF logic\n    // Use startDate and endDate as Date objects for the export\n    const startDate = new Date(self.ctx.$scope.startDate);\n    const endDate = new Date(self.ctx.$scope.endDate);\n    exportToPDF(self.ctx.$scope.reportDataSorted || [], startDate, endDate);\n  };\n};\n\nfunction applySortAndDetectChanges() {\n  if (!self.ctx.$scope.reportData) {\n    self.ctx.$scope.reportDataSorted = [];\n    self.ctx.detectChanges();\n    return;\n  }\n\n  let sortedData = [...self.ctx.$scope.reportData];\n\n  sortedData.sort((a, b) => {\n    let valA = a[self.ctx.$scope.sortColumn];\n    let valB = b[self.ctx.$scope.sortColumn];\n\n    // Handle consumption sorting with error cases\n    if (self.ctx.$scope.sortColumn === 'consumptionKwh') {\n      const errorOrNullA = a.error !== null || a.consumptionKwh === null;\n      const errorOrNullB = b.error !== null || b.consumptionKwh === null;\n\n      if (errorOrNullA && !errorOrNullB) return 1;\n      if (!errorOrNullA && errorOrNullB) return -1;\n      if (errorOrNullA && errorOrNullB) {\n        // Fallback to device name sorting when both have errors\n        valA = a.deviceName || '';\n        valB = b.deviceName || '';\n      }\n    }\n\n    // Handle null/undefined values\n    if (valA === null || valA === undefined) {\n      valA = typeof valB === 'number' ? Infinity : '';\n    }\n    if (valB === null || valB === undefined) {\n      valB = typeof valA === 'number' ? Infinity : '';\n    }\n\n    // Perform comparison based on value types\n    let comparison = 0;\n    if (typeof valA === 'string' && typeof valB === 'string') {\n      comparison = valA.localeCompare(valB);\n    } else if (typeof valA === 'number' && typeof valB === 'number') {\n      comparison = valA - valB;\n    } else {\n      comparison = String(valA).localeCompare(String(valB));\n    }\n\n    return self.ctx.$scope.sortReverse ? -comparison : comparison;\n  });\n\n  self.ctx.$scope.reportDataSorted = sortedData;\n  self.ctx.detectChanges();\n}\n\nasync function fetchConsumptionData() {\n  console.log('fetchConsumptionData called');\n\n  if (!self.ctx.$scope.reportData || !Array.isArray(self.ctx.$scope.reportData) || self.ctx.$scope.reportData.length === 0) {\n    console.log(\"Relatório: Nenhum dispositivo com atributos para buscar dados.\");\n    return;\n  }\n\n  self.ctx.$scope.isLoading = true;\n  self.ctx.$scope.errorMessage = null;\n  self.ctx.detectChanges();\n\n  // Ensure each device has the required properties\n  self.ctx.$scope.reportData = self.ctx.$scope.reportData.map(device => ({\n    ...device,\n    deviceName: device.deviceName || 'Unknown Device',\n    centralId: device.centralId || null,\n    slaveId: device.slaveId || null,\n    consumptionKwh: null,\n    error: device.error || null,\n    isValid: device.isValid || false\n  }));\n\n  const devicesToFetch = self.ctx.$scope.reportData\n    .filter(d => d.isValid && d.centralId && d.slaveId !== null && !d.error)\n    .map(d => ({ centralId: d.centralId, slaveId: d.slaveId }));\n\n  console.log('Devices to fetch:', devicesToFetch);\n\n  if (devicesToFetch.length === 0) {\n    self.ctx.$scope.isLoading = false;\n    console.log(\"Relatório: Nenhum dispositivo válido para buscar dados de consumo.\");\n    self.ctx.detectChanges();\n    return;\n  }\n\n  try {\n    // Use Sao Paulo timezone and correct day boundaries\n    const startTs = getSaoPauloISOString(self.ctx.$scope.startDate, false);\n    const endTs = getSaoPauloISOString(self.ctx.$scope.endDate, true);\n    console.log('Fetching data for period:', { start: startTs, end: endTs });\n\n    const params = {\n      devices: devicesToFetch,\n      startTs,\n      endTs,\n      timezone: 'America/Sao_Paulo'\n    };\n\n    console.log('Request params:', params);\n\n    const response = await fetch(`${self.ctx.$scope.apiBaseUrl}/api/v1/energy-readings/batch-period-sum`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(params)\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({ error: `API request failed with status ${response.status}` }));\n      throw new Error(errorData.error || `API request failed with status ${response.status}`);\n    }\n\n    const data = await response.json();\n    console.log('API Response (raw):', data);\n\n    // Update consumption data for each device\n    self.ctx.$scope.reportData = self.ctx.$scope.reportData.map(device => {\n      if (device.error) return device; // Keep devices with errors unchanged\n\n      const deviceData = data.find(d =>\n        d.centralId === device.centralId &&\n        d.slaveId === device.slaveId\n      );\n\n      return {\n        ...device,\n        consumptionKwh: deviceData && deviceData.consumptionKwh != null ? Number(deviceData.consumptionKwh) : null,\n        error: deviceData ? null : \"No consumption data found for the selected period\"\n      };\n    });\n\n    console.log('Mapped reportData after API:', self.ctx.$scope.reportData);\n    applySortAndDetectChanges();\n    console.log('reportDataSorted for table:', self.ctx.$scope.reportDataSorted);\n  } catch (error) {\n    console.error(\"Error fetching consumption data:\", error);\n    self.ctx.$scope.errorMessage = error.message || \"Failed to fetch consumption data\";\n    self.ctx.$scope.reportData = self.ctx.$scope.reportData.map(device => ({\n      ...device,\n      error: device.error || \"Failed to fetch consumption data\"\n    }));\n    applySortAndDetectChanges();\n  } finally {\n    self.ctx.$scope.isLoading = false;\n    self.ctx.detectChanges();\n  }\n}\n\nself.onDataUpdated = function() {\n  // Do NOT call fetchConsumptionData here\n};\n\nself.onEditModeChanged = function() {\n  self.ctx.detectChanges();\n};\n\nself.onMobileModeChanged = function() {\n  self.ctx.detectChanges();\n};\n\nself.onSettingsChanged = function() {\n  self.ctx.detectChanges();\n};\n",
      "settingsSchema" : "{\r\n    \"schema\": {\r\n        \"type\": \"object\",\r\n        \"title\": \"Settings\",\r\n        \"properties\": {\r\n            \"subtitle\":{\r\n                \"type\":\"string\",\r\n                \"title\": \"Subtítulo do Relatorio\"\r\n            }\r\n        },\r\n        \"required\": [\"subtitle\"]\r\n    },\r\n    \"form\": [\r\n        \"subtitle\"\r\n    ]\r\n}",
      "dataKeySettingsSchema" : "{}\n",
      "hasBasicMode" : false,
      "defaultConfig" : "{\"showTitle\":false,\"backgroundColor\":\"#FFFFFF\",\"color\":\"rgb(0, 0, 0)\",\"padding\":\"8px\",\"settings\":{\"centralId\":\"6354365436543654-Sdvzs2f5dbv4z2sd5f4v3z6d\"},\"title\":\"Report\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":true,\"enableFullscreen\":true,\"borderRadius\":\"10px\",\"widgetStyle\":{},\"widgetCss\":\"\",\"titleStyle\":{\"fontSize\":\"16px\",\"fontWeight\":400},\"pageSize\":1024,\"noDataDisplayMessage\":\"\",\"enableDataExport\":false,\"useDashboardTimewindow\":true,\"displayTimewindow\":true,\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.25096343243849395,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}}}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "66476500-350c-11f0-8cbd-2b87fdb093e1"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}